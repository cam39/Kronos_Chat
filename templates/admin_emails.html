<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Admin Emails - KRONOS</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        body { background: #0a0a0a; color: #fff; font-family: 'Inter', sans-serif; padding: 20px; }
        .admin-container { max-width: 1200px; margin: 0 auto; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: #1a1a1a; padding: 20px; border-radius: 12px; border: 1px solid #333; text-align: center; }
        .stat-value { font-size: 2em; color: #CCFF00; font-weight: bold; }
        .stat-label { color: #888; font-size: 0.9em; }
        table { width: 100%; border-collapse: collapse; background: #1a1a1a; border-radius: 12px; overflow: hidden; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #333; }
        th { background: #222; color: #CCFF00; }
        .status-sent { color: #00ff00; }
        .status-failed { color: #ff0000; }
        .status-pending { color: #ffa500; }
        .status-retrying { color: #00aaff; }
        .open-badge { background: #CCFF00; color: #000; padding: 2px 6px; border-radius: 4px; font-size: 0.8em; font-weight: bold; }
    </style>
</head>
<body>
    <div class="admin-container">
        <h1>Monitoring des Emails</h1>
        
        <div class="stats-grid" id="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="stat-total">-</div>
                <div class="stat-label">Total Envoyés</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-sent">-</div>
                <div class="stat-label">Succès</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-failed">-</div>
                <div class="stat-label">Échecs</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-open-rate">-</div>
                <div class="stat-label">Taux d'ouverture</div>
            </div>
        </div>

        <table>
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Destinataire</th>
                    <th>Sujet</th>
                    <th>Statut</th>
                    <th>Essais</th>
                    <th>Ouvert</th>
                </tr>
            </thead>
            <tbody id="email-log-body">
                <!-- Rempli via JS -->
            </tbody>
        </table>
    </div>

    <script>
        async function loadStats() {
            try {
                const res = await fetch('/api/admin/emails');
                const data = await res.json();
                
                if (!res.ok) throw new Error(data.error || "Erreur lors du chargement");

                // Update Stats
                document.getElementById('stat-total').textContent = data.stats.total;
                document.getElementById('stat-sent').textContent = data.stats.sent;
                document.getElementById('stat-failed').textContent = data.stats.failed;
                document.getElementById('stat-open-rate').textContent = data.stats.open_rate + '%';

                // Update Table
                const tbody = document.getElementById('email-log-body');
                tbody.innerHTML = data.emails.map(email => `
                    <tr>
                        <td>${new Date(email.created_at).toLocaleString()}</td>
                        <td>${email.recipient}</td>
                        <td>${email.subject}</td>
                        <td class="status-${email.status}">${email.status.toUpperCase()}</td>
                        <td>${email.attempts}</td>
                        <td>${email.is_opened ? '<span class="open-badge">OUI</span>' : 'NON'}</td>
                    </tr>
                `).join('');

            } catch (err) {
                console.error(err);
                alert("Erreur: " + err.message);
            }
        }

        loadStats();
        setInterval(loadStats, 30000); // Rafraîchir toutes les 30s
    </script>
</body>
</html>
